{% extends "base.html" %}
{% load form_extras %}

{% block content %}
<div class="card shadow-sm" id="problem-container">
  <div class="card-body">
    <h2 class="card-title">–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–æ–±–ª–µ–º—ã</h2>

    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {% for error in form.non_field_errors %}
          <div>{{ error }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" class="mt-4" id="problem-form" action="">
      {% csrf_token %}

      <fieldset class="mb-4">
        <legend class="h5">üß≠ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–∏—Ç—É–∞—Ü–∏–∏</legend>
        <div class="row g-3">
          {% for field in form %}
            {% if field.name|not_in:"gpt_key_question,r1_as_is,r2_to_be,gap,problem_type" %}
              <div class="col-md-6">
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                {% if form.is_bound %}
                  {% if field.errors %}
                    {{ field|add_class:"form-control is-invalid" }}
                  {% else %}
                    {{ field|add_class:"form-control is-valid" }}
                  {% endif %}
                {% else %}
                  {{ field|add_class:"form-control" }}
                {% endif %}
                {% if field.help_text %}
                  <div class="form-text">{{ field.help_text }}</div>
                {% endif %}
                {% for error in field.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </fieldset>

      <fieldset class="mb-4">
        <legend class="h5">üéØ –¶–µ–ª–µ–≤–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ (R1 ‚Üí R2 ‚Üí GAP)</legend>

        <div class="mb-3">
          <label for="{{ form.r1_as_is.id_for_label }}" class="form-label">R1: –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (as-is)</label>
          {{ form.r1_as_is|add_class:"form-control" }}
          {% for error in form.r1_as_is.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="mb-3">
          <label for="{{ form.r2_to_be.id_for_label }}" class="form-label">R2: –ñ–µ–ª–∞–µ–º–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (to-be)</label>
          {{ form.r2_to_be|add_class:"form-control" }}
          {% for error in form.r2_to_be.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="mb-3">
          <label for="{{ form.gap.id_for_label }}" class="form-label">GAP: –†–∞–∑—Ä—ã–≤ –º–µ–∂–¥—É —Ç–µ–∫—É—â–∏–º –∏ –∂–µ–ª–∞–µ–º—ã–º</label>
          {{ form.gap|add_class:"form-control" }}
          {% for error in form.gap.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>

        <div class="mb-3">
          <label for="{{ form.problem_type.id_for_label }}" class="form-label">–¢–∏–ø –ø—Ä–æ–±–ª–µ–º—ã</label>
          {{ form.problem_type|add_class:"form-select" }}
          {% for error in form.problem_type.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      </fieldset>

      <button type="submit" class="btn btn-primary mt-3 w-100" id="submit-button">
        üöÄ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤–æ–π –≤–æ–ø—Ä–æ—Å
      </button>
    </form>

    {% if form.cleaned_data.gpt_key_question %}
      <div class="alert alert-info mt-4">
        <strong>üí° GPT –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∫–ª—é—á–µ–≤–æ–π –≤–æ–ø—Ä–æ—Å:</strong><br>
        <em>{{ form.cleaned_data.gpt_key_question }}</em>
      </div>
    {% endif %}

    {% if form.cleaned_data.analysis %}
      <div class="alert alert-secondary mt-3">
        <strong>üìä GPT-–∞–Ω–∞–ª–∏–∑:</strong><br>
        <p class="mb-0">{{ form.cleaned_data.analysis }}</p>
      </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const textareas = document.querySelectorAll("textarea");
    textareas.forEach(textarea => {
      const autoResize = () => {
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + "px";
      };
      textarea.addEventListener("input", autoResize);
      autoResize(); // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    });
  });
</script>
{% endblock %}
